# Changelog — 2026-02-19

本文件記錄第四階段（Phase 4）實作完成後的所有新功能、改善項目與 Bug 修正。

---

## 新功能

### System Tray 支援
- 使用 **H.NotifyIcon.WinUI** 在系統匣顯示應用程式圖示。
- 關閉主視窗時改為隱藏（最小化至匣），而非結束程式。
- 雙擊匣圖示可還原主視窗。
- 右鍵選單包含：**顯示視窗**、**最近開啟的程式**（最多 10 筆）、**結束**。

### 資料夾分組管理
- 新增「新增資料夾」按鈕，可建立具名資料夾以分類管理程式項目。
- 支援**巢狀資料夾**（資料夾內可再建立子資料夾）。
- 資料夾可展開 / 收合，展開狀態會**持久化**至 `apps.json`。
- 資料夾支援右鍵選單：**重新命名**、**刪除**（含確認對話框）。

### 拖放排序（樹狀結構內）
- 啟用 `TreeView.CanReorderItems`，可在清單內以拖曳方式重新排序項目。
- 將項目拖曳至資料夾節點上可**移入**該資料夾；拖曳至空白區域可**移出**至最外層。
- 拖曳懸停於資料夾節點 600 ms 後會自動展開，方便移入子層。
- 禁止將項目拖曳至其他**程式項目**上（僅允許資料夾或根層）。

### 自訂圖示
- 編輯對話框新增「自訂圖示」欄位，可從 `.ico` 或 `.exe` 選取替代圖示。
- 變更路徑或自訂圖示時，**自動清除**磁碟快取並重新載入。

### 雙擊啟動
- 在樹狀清單或搜尋結果中**雙擊**程式項目可直接啟動，無需點擊啟動按鈕。

### 右鍵選單「開啟所在資料夾」
- 程式項目右鍵選單新增「開啟所在資料夾」，以 Explorer 開啟並選取該 `.exe` 檔案。

### 記住視窗大小
- 應用程式關閉時儲存視窗尺寸，下次啟動時自動還原。

---

## 改善項目

### UI 外觀
- 啟用 `ExtendsContentIntoTitleBar = true`，Title Bar 與內容區背景（Mica）無縫整合。
- 縮減清單項目列高，使整體排列更為緊湊。

### 本地化
- `Loc` 服務改從**嵌入式 `.resw` 資源**讀取字串作為 fallback，移除原有的硬編碼字典，新增字串只需編輯 `Resources.resw` 即可生效。

### 圖示
- `app-icon.ico` 以 `EmbeddedResource` 嵌入 binary，確保非封裝模式下 System Tray 圖示能正確載入。
- 為 App 及 System Tray 設定正式應用程式圖示。

### 拖放（外部檔案）
- 外部拖放（桌面 `.exe` / `.lnk` 拖入視窗）的接收目標從 `RootGrid` 移至 `AppTreeView`，與內部排序拖曳使用相同目標，消除雙重事件路由問題。

### 檔案選擇器
- `FileOpenPicker` 新增 `SuggestedStartLocation` 與 `SettingsIdentifier`，系統可記憶上次開啟的目錄位置。

---

## Bug 修正

| 修正項目 | 說明 |
|---|---|
| 搜尋結果雙擊無效 | 搜尋模式下雙擊項目現可正確啟動程式 |
| 無法拖曳至最外層 | 拖曳至空白區域（根層）現可正確移出資料夾 |
| 右鍵選單位置錯誤 | 選單改在滑鼠游標旁顯示，而非元素預設角落 |
| 右鍵選單中文未顯示 | 修正本地化查詢邏輯，中文環境下選單文字正確顯示 |
| 編輯對話框標題未本地化 | 「新增項目」與「編輯項目」對話框標題現正確顯示本地化字串 |
| System Tray 右鍵選單失效 | 修正 `RelayCommand` 綁定問題，選單項目點擊可正確觸發 |
| System Tray「結束」無法關閉程式 | 修正退出流程，確保程式完整結束 |

---

## 資料格式變更

`apps.json` 升版至 **Version 2**，資料結構從原先的 `List<AppItem>` 改為 `AppData`：

```json
{
  "Version": 2,
  "Items": [ /* TreeItem（AppItem 或 FolderItem），支援巢狀 */ ],
  "RecentLaunches": [ /* 最近啟動紀錄，最多 10 筆 */ ],
  "WindowState": { "Width": 400, "Height": 600 }
}
```

`DataService.Load()` 保留對舊版 `List<AppItem>` 格式的向後相容讀取。
